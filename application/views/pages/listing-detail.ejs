<!DOCTYPE html>
<html lang="en">
  <!-- DEBUG: Listing Detail EJS -->

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <%- include('../partials/header', { title: 'Listing Detail' }) %>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <title>Listing Detail</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 30px;
      background-color: #f9f9f9;
      color: #333;
    }
    
    .listing-detail-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 30px;
      margin: 50px auto;
      max-width: 1000px;
    }

    .listing-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 40%;
    }

    .listing-image-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 6px;
      border: 2px solid #7b5cff;
      margin-bottom: 15px;
    }

    .listing-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .seller-info {
      font-size: 1.25rem;
      color: black;
      text-align: center;
    }

    .listing-right {
      width: 60%;
    }

    h1 {
      margin-bottom: 15px;
      font-size: 2rem;
      color: #222;
      word-wrap: break-word;
    }

    p {
      font-size: 1.1rem;
      line-height: 1.5;
      color: #444;
      margin: 10px 0;
      word-wrap: break-word;
    }

    .price {
      font-weight: bold;
      font-size: 1.3rem;
      margin: 15px 0;
      color: #000;
    }

    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .action-button {
      background-color: #e6d5f5;
      color: #333;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .action-button:hover {
      background-color: #d6c1f0;
    }

    .description-box {
     padding: 10px 15px;      
     border-radius: 6px;           
     max-width: 500px; 
     background-color: #E0E0E0;
     color: black;
     max-width: 100%;
  
    }
    .category-box {
    display: inline-block;
    padding: 10px 15px;
    border-radius: 6px;
    background-color: #E0E0E0;
    color: black;
    max-width: 100%;
    white-space: nowrap;
    }
    .seller-profile-box {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    }

  .profile-picture {
  width: 100px;
  height: 80px;
  border-radius: 4px;
  object-fit: cover;
  border: 2px solid black;
  }

  .seller-info {
  font-size: 1.25rem;
  color: black;
  margin: 0;
  }
  </style>
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JHX65F1PNK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JHX65F1PNK');
</script>

<body x-data="listingDetailApp()" x-init="init()">
  <div class="listing-detail-container" x-show="listing">
    

    <!-- Left side: Image + Seller Info -->
    <div class="listing-left">
      <div class="listing-image-container">
        <template x-if="listing.primary_image">
          <img class="listing-image" :src="listing.primary_image" :alt="listing.listing_name" />
        </template>

        <template x-if="!listing.primary_image">
          <div class="listing-image">No image available</div>
        </template>
      </div>

      <div class="seller-profile-box">
  <% if (user.profile_picture) { %>
    <img class="profile-picture" src="<%= user.profile_picture %>" alt="Profile Picture" />
  <% } else { %>
    <div class="profile-picture"></div> <!-- fallback box -->
  <% } %>

  <p class="seller-info">
    <strong>Seller:</strong>
    <span x-text="listing.firstName && listing.lastName ? `${listing.firstName} ${listing.lastName}` : 'Unknown Seller'"></span>
  </p>
</div>

    </div>

    <!-- Right side: All listing info -->
    <div class="listing-right">

      <h1>Itemmm: <span x-text="listing.listing_name"></span></h1>

      <p class="category-box">
  <strong>Category:</strong> <a x-text="listing.category_name || 'No category assigned'"></a>
    </p>


      <p class ="description-box">
        <strong>Description:</strong>
        <span x-text="listing.listing_description || 'No description available.'"></span>
      </p>

      <p class="price">
        Price: $
        <span x-text="formatPrice(listing.price)"></span>
      </p>

     <div class="action-buttons">
      <a :href="`/message/${listing.listing_id}`" class="action-button">Message Owner</a>
      <a href="/results" class="action-button">Back to Results</a>

      <template x-if="listing.category_name === 'Services'">
        <a :href="`/calendar/${listing.listing_id}`" class="action-button">
          View Availability
        </a>
      </template>
    </div>


  </div>

  <%- include('../partials/footer') %>

  <script>
    function listingDetailApp() {
      return {
        listing: null,
        user: {},

        init() {
          const pathParts = window.location.pathname.split('/');
          const listingId = pathParts[pathParts.length - 1];

          fetch(`/api/listing/${listingId}`)
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                this.listing = data.listing;
                this.user = data.user || {};
                console.log("Fetched listing:", this.listing); 
              } else {
                console.error('Failed to fetch listing');
              }
            })
            .catch(err => console.error('Error:', err));
        },

        formatPrice(price) {
          if (!price) return '0.00';
          return parseFloat(price).toFixed(2);
        }
      }
    }
  </script>
</body>
</html>